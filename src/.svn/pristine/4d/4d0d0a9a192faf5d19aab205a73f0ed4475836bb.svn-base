define(["jquery",'common',"modals"],function($,common,modals){
	for(var key in modals){
		modals[key].post_flag = false;
	}
	var alitong_apply = modals.alitong_apply;
	var alitong_protocol = modals.alitong_protocol;
	var alitong_login = modals.alitong_login;
	var alitong_register = modals.alitong_register;
	var regist_protocol = modals.regist_protocol;
	var regist_protocol_2 = modals.regist_protocol_2;
	var alerts = modals.alerts;
	// alerts("提示你","这是一个弹窗");

	//获取手机短信验证码
function getmobVerify(){
    var obj = $(this);
    var userName = alitong_register.cover.find("div[data-name='username']").find("input");
    var verifyCode = alitong_register.cover.find("div[data-name='verifyCode']").find("input");
    var textBool = obj.text().indexOf("获取验证码")>=0;
    var mob = userName.val();
    var verifycode = verifyCode.val();
    if(userName && verifyCode && textBool){
        $.ajax({
            type : 'get',
            url : domain + '/sendVerifySMS.html?mob=' + mob
            + '&verifycode=' + verifycode,
            success : function(e) {
                if (e.success) {
                    var time = 120;
                    obj.text(time + "秒");
                    time--;
                    obj.data('msgCode',e.data);
                    intervalId = setInterval(function() {
                        obj.text(time + "秒");
                        if (time == 0) {
                            clearInterval(intervalId);
                            obj.text("获取验证码");
                        }
                        time--;
                    }, 1000);
                } else {
                    alerts(e.message);
                }
            }
        });
    }
}

 //验证验证码和手机验证码
function checkRegisterParam(params,msgcode){
    var smsCode = params.smsCode;
    if(msgcode != smsCode){
        alerts("手机验证码错误");
        return false;
    }
    var password = params.password;
    var repassword = params.repassword;
    if (repassword != password) {
        alerts("两次输入密码不一致");
        return false;
    }
    alitong_register.cover.find(".big").attr("disabled","disabled");
    return true;
}

	// alitong_login.showmodal();
	// regist_protocol.showmodal();
	// alitong_register.showmodal();
	// alitong_apply.showmodal();
	//轮播图
	var banner_center = {
		slide: ".banner_center .banner_pics .slide_part",
		single: ".banner_center .banner_pics .slide_part .single",
		tip: ".banner_center .banner_index .main_index .indexs .index",
		index: 0,
		pic_width: 742,
		move_func : function () {
			var index = banner_center.index;
			var width = banner_center.pic_width;
			$(banner_center.slide)
			.stop()
			.animate({left: -index*width+"px"}, "fast");
		},
		addindex: function () {
			var index = banner_center.index;
			var limit = $(banner_center.tip).length-1;
			banner_center.index = ++index;
			if(banner_center.index>limit){
				banner_center.index = 0;
			}

		},
		tip_hover_in: function () {
			clearInterval(banner_center.timer1);
			banner_center.index = $(this).index();
			banner_center.move_func();
		},
		tip_hover_out: function () {
			banner_center.timer1 = setInterval(function (){
				banner_center.addindex();
				banner_center.move_func();
			}, 2000);
		},
		init: function () {
			banner_center.timer1 = setInterval(function (){
				banner_center.addindex();
				banner_center.move_func();
			}, 2000);
			$(banner_center.tip).hover(banner_center.tip_hover_in,banner_center.tip_hover_out);
		}
	};
	//banner右侧
	var banner_right = {
		title: ".banner_right .apply_guide_step .guide_step_content .step .step_title",
		pic: ".step_content",
		step: ".banner_right .apply_guide_step .guide_step_content .step",
		active_func: function () {
			$(this).parents(".step").addClass('active').siblings('.step').removeClass('active');
		},
		init: function () {
			$(banner_right.title).hover(banner_right.active_func);
		}
	};
	// var today_sell = {
	// 	part: ".today .today_nav .part",
	// 	page: ".today .today_content .content_product",
	// 	index: 0,
	// 	setindex: function (index) {
	// 		today_sell.index = index;
	// 	},
	// 	setactive: function () {
	// 		var index = today_sell.index;
	// 		$(today_sell.part).eq(index).addClass('active').siblings('.part').removeClass('active');
	// 		(today_sell.page).eq(index).addClass('active').siblings('.content_product').removeClass('active');
	// 	},
	// 	addindex: function () {
	// 		today_sell.index = today_sell.index + 1;
	// 	},
	// 	reduceindex: function () {
	// 		today_sell.index = today_sell.index - 1;
	// 	},
	// 	index_cheack: function () {
	// 		var limit = $(today_sell.part).length;
	// 		var index = today_sell.index;
	// 		if(index>limit){
	// 			today_sell.index = limit;
	// 		}
	// 		if(index<0){
	// 			today_sell.index = 0;
	// 		}
	// 	},
	// 	init: function () {
	// 		today_sell.setactive();
	// 	}
	// };


	//阿里通协议逻辑
	alitong_protocol.cover.find('.big').click(function(event) {
		if($(this).hasClass('disable')){
			return;
		}
		if (!$(this).hasClass('disable')){
			alitong_protocol.hidemodal();
			alitong_apply.showmodal();
		}
	});

	//阿里通表单逻辑
	alitong_apply.cover.find('.sure').click(function(event) {
		if(alitong_apply.post_flag) return;
		var cansend = alitong_apply.cansend();
		var memberStore = alitong_apply.getresult();
		if(alitong_apply.uptype=="yijianshangchuan"){
			alitong_apply.post_flag = true;
			//一键上传提交
			if (cansend) {
			    //数据通过校验，转换数据格式进行ajax请求
			    memberStore = JSON.stringify(memberStore);
			    $.ajax({
			        async: true,
			        type: "POST",
			        url: "/product/memberstoreadd",
			        data: {"memberStore": memberStore},
			        success: function (result) {
			            //请求成功，跳转至阿里的铺货授权页面
			            alitong_apply.post_flag = false;
			            if (result.data) {
			                window.location.href = "http://www.dawawang.com/services/alibaba.html";
			            }
			        }
			    });
			}
			return;
		}
		if(alitong_apply.uptype=="yijiandaifa"){
			alitong_apply.post_flag = true;
			//一键代发提交
			if (cansend) {
			    //数据通过校验，转换数据格式进行ajax请求
			    memberStore = JSON.stringify(memberStore);
			    $.ajax({
			        async: true,
			        type: "POST",
			        url: "/product/memberstoreadd",
			        data: {"memberStore": memberStore},
			        success: function (result) {
			            //请求成功，跳转至阿里的抓单授权页面
			            alitong_apply.post_flag = false;
			            if (result.data) {
			                window.location.href = "http://www.dawawang.com/services/alibaba_product.html";
			            }
			        }
			    });
			}
			return;
		}
	});

	//登录逻辑
	alitong_login.cover.find(".big").click(function(){
		if(alitong_login.post_flag) return;
		var result = alitong_login.getresult();
		var cansend = alitong_login.cansend();
		if (cansend) {
			    //数据通过校验，转换数据格式进行ajax请求
			    // result = JSON.stringify(result);
			    alitong_login.post_flag = true;
			    $.ajax({
			        async: true,
			        type: "POST",
			        url: "/login.html",
			        data: result,
			        success: function (result) {
			            //请求成功
			            alitong_login.post_flag = false;
			            alitong_login.hidemodal();
			            alitong_protocol.showmodal();
			        }
			    });
			}
	});

	//注册页弹出
	alitong_login.cover.find('.login_tag a:last-child').click(function(event) {
		event.preventDefault();
		alitong_login.hidemodal();
		alitong_register.showmodal();
	});

	//注册页逻辑
	alitong_register.cover.find('.big').click(function(event) {
		if(alitong_register.post_flag) return;
		/* Act on the event */
		var able = !$(this).hasClass('disable');
		var result = alitong_login.getresult();
		var msg = alitong_register.cover.find('.getcode').data('msgcode')
		var msgcheck = checkRegisterParam(result,msg);
		if(able&&msgcheck) {
			alitong_register.post_flag = true;
			$.ajax({
		      type:"POST",
		      url:domain + "/doregister.html",
		      dataType:"json",
		      async : false,
		      data : result,
		      success:function(data){
		      	alitong_register.post_flag = false;
		        alitong_register.hidemodal();
		        alitong_protocol.showmodal();
		      },
		      error:function(){
		        
		      }
		   });
		}
	});

	alitong_register.cover.find("div.fullinput:last").prev().find("span img").attr("src",domain+"/verify.html?d"+new Date().getTime());
	//刷新验证码
	alitong_register.cover.find("div.fullinput:last").prev().find("span img").click(function(){
	    $(this).attr("src",domain+"/verify.html?d"+new Date().getTime());
	});
	alitong_register.cover.find('.getcode').click(getmobVerify);
	//注册协议逻辑
	regist_protocol.cover.find('.big').click(function(event) {
		/* Act on the event */
		regist_protocol.hidemodal();
		alitong_register.cover.find('.checkbox .iconfont').removeClass('nor');
		alitong_register.cover.find('.option .big').removeClass('disable');
	});
	regist_protocol_2.cover.find('.big').click(function(event) {
		/* Act on the event */
		regist_protocol_2.hidemodal();
		alitong_register.cover.find('.checkbox .iconfont').removeClass('nor');
		alitong_register.cover.find('.option .big').removeClass('disable');
	});



	//绑定业务逻辑
	var  procedure = {
		step_1 : ".guide_step_content .step:first-child .step_title",
		step_2 : ".guide_step_content .step:last-child .step_title",
		check_login: isUserLogin,
		step_1_func: function () {
			var _this = this;
			var islogin = procedure.check_login();
			if(islogin){ //已登录
				alitong_apply.uptype = "yijianshangchuan"
				alitong_protocol.showmodal();
			}else {
				// alitong_login.showmodal();
				alitong_login.showmodal();
			}
		},
		step_2_func: function () {
			var _this = this;
			var islogin = procedure.check_login();
			if(islogin){ //已登录
				alitong_apply.uptype = "yijiandaifa";
				alitong_protocol.showmodal();
			}else {
				alitong_login.showmodal();
			}
		},
		init: function () {
			$(procedure.step_1).click(procedure.step_1_func);
			$(procedure.step_2).click(procedure.step_2_func);
		}
	};
	procedure.init();
	banner_center.init();
	banner_right.init();

	$(".search_btn").on('click',function () {
		var keyword = $(".search").val();
		window.location = domain  + "/" + "search.html?keyword=" + keyword +"&alitong=y";
    });
})