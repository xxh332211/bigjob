define(['jquery', 'bootstrap', 'modal','modals'], function ($, bootstrap, modal,modals) {
    //一键铺货授权modal
    //抓单授权modal
    //modals.alitong_apply;
    //实例化登录弹出框
    //modals.alitong_login;
    //阿里通协议弹窗
    //modals.alitong_protocol;
    //注册弹窗
    //modals.alitong_register;
    //注册协议
    //用户服务协议
    //modals.regist_protocol;
    //委托付款三方协议
    //modals.regist_protocol_2;
    //绑定alimodal的关闭按钮的关闭方法
    var close = $("#aliModal").find("button[name='close']");
    close.click(function () {
        $("#aliModal").modal('hide');
    });
    //点击一键铺货到阿里时渲染modal内容，查询当前用户的阿里店铺并渲染select
    function findStore(productId, specPricesDom, priceRangeDom, memberId, selectChoose) {
        selectChoose.html("");
        $.ajax({
            async: false,
            type: "POST",
            url: "/product/memberstores",
            data: {"memberId": memberId},
            success: function (result) {
                //返回值message信息（1：用户未登录4：用户没有授权店铺5：成功6：用户店铺请求提点信息失败）
                if (result.message == "5") {
                    successAliModal(result,productId,specPricesDom,priceRangeDom,selectChoose);
                }else if(result.message == "1"){
                    //用户未登录，进入登录流程
                    alitongLogin();
                }else if(result.message == "4"){
                    //此时用户已登录，但没有授权的店铺，弹出商派阿里通授权协议（此时进行阿里通授权流程）
                    shouquanProtocol();
                }else if(result.message == "6"){
                    //弹出警示信息，关闭弹窗时刷新当前页面
                    $("#aliStoreModal").find("h4.modal-title").html("系统提示");
                    $("#aliStoreModal").find("div.modal-body").html("店铺请求提点信息失败，请去oms设置提点信息。");
                    $('#aliStoreModal').modal('show');
                    $('#aliStoreModal').on('hide.bs.modal', function () {
                        window.location.reload();
                    });
                }
            }
        });
    }

    //正确获取阿里店铺信息（用户已登录，并且获取了该用户的阿里店铺集合）进行弹出框数据填充
    function successAliModal(result,productId,specPricesDom,priceRangeDom,selectChoose){
        //newWin.close();
        var optionHtml = "";
        var options = result.data;
        for (var i = 0; i < options.length; i++) {
            optionHtml += "<option data-scale=" + options[i].scale + " value=" + options[i].memberStore.storeIdProduct + ">" + options[i].memberStore.storeName + "</option>"
        }
        selectChoose.html(optionHtml);
        var scale = Number(selectChoose.find("option:selected").data("scale"));
        selectChoose.change(function(){
            scale = Number(selectChoose.find("option:selected").data("scale"));
            getSkuClass(productId, specPricesDom,scale);
            showPriceRanges(productId, priceRangeDom,scale);
            $('#aliModal').modal('show');
        });
        getSkuClass(productId, specPricesDom,scale);
        showPriceRanges(productId, priceRangeDom,scale);
        $('#aliModal').modal('show');
    }
    //点击下载数据包时渲染modal的内容，查询当前用户的阿里店铺并渲染select
    /*function findStore2(memberId, selectChoose) {
     selectChoose.html("");
     // 打开页面，此处最好使用提示页面
     //var newWin = window.open("http://www.dawawang.com");
     $.ajax({
     async: false,
     type: "POST",
     url: "/product/memberstores",
     data: {"memberId": memberId},
     success: function (result) {
     if (result.message == "5") {
     //newWin.close();
     var optionHtml = "";
     var options = result.data;
     for (var i = 0; i < options.length; i++) {
     optionHtml += "<option value=" + options[i].memberStore.storeIdProduct + ">" + options[i].memberStore.storeName + "<span style='display:none'>"+options[i].scale+"</span></option>"
     }
     selectChoose.html(optionHtml);

     $("#productToAliForm").find("div.priceRangesBySkuNum").hide();
     $("#productToAliForm").find("div.specPricesBySkuClass").hide();
     $("#productToAliForm").find("div.quoteDiv").hide();
     $('#aliModal').modal('show');

     }else{
     aliStoreModalShow(result);
     }
     }
     });
     shouQuanClick();
     }*/
    //渲染授权提示框
    /*function aliStoreModalShow(result){
     //http://www.dawawang.com/services/alibaba.html
     var a = "<a id='storeShouQuan' class='btns btn-primary' style='color:white; margin:10px 5px; background:#ff7300;width:160px;border:none;' href='javascript:;'>" +
     "阿里通功能开通</a>";
     //http://www.dawawang.com/services/alibaba_product.html
     var a2 = "<a id='productShouQuan' class='btns btn-primary' style='color:white; margin:10px 5px; background:#ff7300;width:160px;border:none;'" +
     "href=' javascript:;'>" +
     "一件铺货功能开通</a>";
     //http://www.dawawang.com/services/alibaba.html
     var a3 = "<a id='aliMessage' class='btns btn-primary' style='color:white; margin:10px 5px; background:#ff7300;width:160px;border:none;' href=' javascript:;'>" +
     "查看产品介绍</a>";
     var d1 = "<div>" +
     "您的账号未开通阿里通授权功能，请先开通阿里通授权功能以及一键铺货功能。欲了解产品详情，请点击【查看产品介绍】" +
     "</div>";
     if (result.message == "1") {
     $("#aliStoreModal").find("h4.modal-title").html("登录提示");
     $("#aliStoreModal").find("div.modal-body").html("使用阿里通功能需要登录商城，关闭此弹窗后会跳转至登录页面。");
     $('#aliStoreModal').modal('show');
     $('#aliStoreModal').on('hide.bs.modal', function () {
     window.location.href = result.backUrl;
     });
     } else if (result.message == "2") {
     //newWin.close();
     $("#aliStoreModal").find("h4.modal-title").html("阿里通授权店铺绑定提示");
     $("#aliStoreModal").find("div.modal-body").html("");
     $("#aliStoreModal").find("div.modal-body").append(d1);
     $("#aliStoreModal").find("div.modal-body").append(a);
     $("#aliStoreModal").find("div.modal-body").append(a3);
     $("#aliStoreModal").find("div.modal-footer").hide();
     $('#aliStoreModal').modal('show');
     } else if (result.message == "3") {
     //newWin.close();
     $("#aliStoreModal").find("h4.modal-title").html("阿里通授权商品绑定提示");
     $("#aliStoreModal").find("div.modal-body").html("");
     $("#aliStoreModal").find("div.modal-body").append(d1);
     $("#aliStoreModal").find("div.modal-body").append(a2);
     $("#aliStoreModal").find("div.modal-body").append(a3);
     $("#aliStoreModal").find("div.modal-footer").hide();
     $('#aliStoreModal').modal('show');
     } else if (result.message == "4") {
     //newWin.close();
     $("#aliStoreModal").find("h4.modal-title").html("阿里通授权绑定提示");
     $("#aliStoreModal").find("div.modal-body").html("");
     $("#aliStoreModal").find("div.modal-body").append(d1);
     $("#aliStoreModal").find("div.modal-body").append(a);
     $("#aliStoreModal").find("div.modal-body").append(a2);
     $("#aliStoreModal").find("div.modal-body").append(a3);
     $("#aliStoreModal").find("div.modal-footer").hide();
     $('#aliStoreModal').modal('show');
     }else if (result.message == "6") {
     $("#aliStoreModal").find("h4.modal-title").html("提示");
     $("#aliStoreModal").find("div.modal-body").html("OMS提点信息有误");
     $('#aliStoreModal').modal('show');
     $('#aliStoreModal').on('hide.bs.modal', function () {
     window.location.reload();
     });

     }
     }*/
    //授权信息组装完成后绑定授权modal的点击事件
    /*function shouQuanClick(){
     $("#storeShouQuan").click(function () {
     $('#aliStoreModal').modal('hide');
     storeShouQuan(1);
     });
     $("#productShouQuan").click(function () {
     $('#aliStoreModal').modal('hide');
     storeShouQuan(2);
     });
     $("#aliMessage").click(function () {
     window.location.href = "http://www.dawawang.com/resources/frontV1/html/alitong/alitong_introduce2.html";
     });
     }*/
    //查询当前商品的sku信息渲染规格报价
    function getSkuClass(productId, specPricesDom,scale) {
        specPricesDom.html();
        $.ajax({
            async: false,
            type: "POST",
            url: "/product/storeGoods",
            data: {"productId": productId},
            success: function (result) {
                if (result.message == "success") {
                    specPricesDom.html("");
                    var skuHtml = " <table class='table table-bordered table-condensed'><thead><tr><th>大袜价格</th><th>阿里单价</th><th>建议零售价</th></tr></thead><tbody>"
                    var productGoods = result.data;
                    for (var i = 0; i < productGoods.length; i++) {
                        if(i == 0){
                            skuHtml += "<tr class='specPrice'>" +
                                "<td><input  name='skucode' type='hidden' value=" + productGoods[i].sku + ">" +
                                "<span style='display: none'>" + productGoods[i].normName.substring(productGoods[i].normName.indexOf(',') + 1, productGoods[i].normName.length) + "</span>" +
                                "<input  style='width:112px;border:1px solid #D7D7D7;' name='dawaPrice' type='number' value=" + productGoods[i].mallPcPrice + " readonly='readonly'>" +
                                "</td>" +
                                "<td><input data-scale=" + parseInt((productGoods[i].mallPcPrice + productGoods[i].mallPcPrice*scale/100)*100)/100 + " style='width:112px;border:1px solid #D7D7D7;' name='price' type='number'>" +
                                "</td>" +
                                "<td><input style='width:112px;border:1px solid #D7D7D7;' type='number' name='retailprice'></td></tr>";
                        }else{
                            skuHtml += "<tr class='specPrice' style='display:none;'>" +
                                "<td><input  name='skucode' type='hidden' value=" + productGoods[i].sku + ">" +
                                "<span style='display: none'>" + productGoods[i].normName.substring(productGoods[i].normName.indexOf(',') + 1, productGoods[i].normName.length) + "</span>" +
                                "<input style='width:112px;border:1px solid #D7D7D7;' name='dawaPrice' type='number' value=" + productGoods[i].mallPcPrice + "readonly='readonly'>" +
                                "</td>" +
                                "<td><input data-scale=" + parseInt((productGoods[i].mallPcPrice + productGoods[i].mallPcPrice*scale/100)*100)/100 + " style='width:112px;border:1px solid #D7D7D7;' name='price' type='number'></td>" +
                                "<td><input style='width:112px;border:1px solid #D7D7D7;' type='number' name='retailprice'></td></tr>";
                        }
                    }
                    skuHtml += "</tbody></table><div style='font-size: x-small;color: red;width:256px;height:17px'></div>";
                    specPricesDom.html(skuHtml);
                    //报价方式的select赋值，并更改为不可编辑
                    $("#productToAliForm").find("select[name='quoteType']").val(1);
                    $("#productToAliForm").find("select[name='quoteType']").prop("disabled", true);
                    //按照sku规格
                    $("#productToAliForm").find("div.priceRangesBySkuNum").hide();
                    $("#productToAliForm").find("div.specPricesBySkuClass").show();
                    //绑定price失去焦点时对比提点价格做出提示
                    specPricesDom.find("input[name='price']").focusout(function(){
                        var pricescale = $(this).data("scale");
                        var price = $(this).val();
                        if(price != "" && Number(price) <= Number(pricescale)){
                            $(this).parent().parent().parent().parent().next().html("你设置的价格低于计算提点后的成本价("+pricescale+")");
                        }else if(price == "" || Number(price) > Number(pricescale)){
                            $(this).parent().parent().parent().parent().next().html("");
                        }
                    })

                }
            }
        });
    };
    //查询当前商品的阶梯价信息渲染
    function showPriceRanges(productId, priceRangeDom,scale) {
        var priceRangeDoms = priceRangeDom.find("tr[class='priceRange']");
        $.ajax({
            async: false,
            type: "POST",
            url: "/product/PriceRange",
            data: {"productId": productId},
            success: function (result) {
                if (result.message == "success") {
                    var productPrice = result.data;
                    for (var i = 0; i < priceRangeDoms.length; i++) {
                        var price = "price" + (i + 1);
                        var priceS = price + "S";
                        if (i > 0) {
                            $(priceRangeDoms[i]).find("input[name='startQuantity']").val(productPrice[priceS]);
                            $(priceRangeDoms[i]).find("input[name='dawaPrice']").val(productPrice[price]);
                            $(priceRangeDoms[i]).find("input[name='price']").attr("data-scale",parseInt((productPrice[price]+productPrice[price]*scale/100)*100)/100);
                        } else {
                            $(priceRangeDoms[i]).find("input[name='startQuantity']").val(result.total);
                            $(priceRangeDoms[i]).find("input[name='dawaPrice']").val(productPrice[price]);
                            $(priceRangeDoms[i]).find("input[name='price']").attr("data-scale",parseInt((productPrice[price]+productPrice[price]*scale/100)*100)/100);
                        }
                        //报价方式的select赋值，并更改为不可编辑
                        $("#productToAliForm").find("select[name='quoteType']").val(2);
                        $("#productToAliForm").find("select[name='quoteType']").prop("disabled", true);
                        //按照sku数量阶梯价
                        $("#productToAliForm").find("div.specPricesBySkuClass").hide();
                        $("#productToAliForm").find("div.priceRangesBySkuNum").show();
                    }
                    //绑定price失去焦点时对比提点价格做出提示
                    priceRangeDoms.find("input[name='price']").focusout(function(){
                        var pricescale = $(this).data("scale");
                        var price = $(this).val();
                        if(price != "" && Number(price) <= Number(pricescale)){
                            $(this).parent().parent().next().children().children().html("你设置的价格低于计算提点后的成本价("+pricescale+")")
                            $(this).parent().parent().next().show();
                        }else if(price == "" ||  Number(price) > Number(pricescale)){
                            $(this).parent().parent().next().children().children().html("");
                            $(this).parent().parent().next().hide();
                        }
                    })
                }
            }
        });
    }
    //封装数量报价对象
    function getPriceRanges(priceRangeDom) {
        var result = {
            success: true,
            message: "",
            data: {}
        };
        var priceRangeDoms = priceRangeDom.find("tr[class='priceRange']");
        var priceRanges = [];
        for (var i = 0; i < priceRangeDoms.length; i++) {
            var priceRange = {};
            priceRange.startQuantity = $(priceRangeDoms[i]).find("input[name='startQuantity']").val();
            if ($.trim(priceRange.startQuantity) == "" || priceRange.startQuantity == null || Number($.trim(priceRange.startQuantity)) <= 0) {
                result.success = false;
                result.message = "起订量必填并且不能小于0";
                return result;
            }
            priceRange.price = $(priceRangeDoms[i]).find("input[name='price']").val();
            if ($.trim(priceRange.price) == "" || priceRange.price == null || Number(priceRange.price) <= 0) {
                result.success = false;
                result.message = "阿里卖价必填并且不能小于0";
                return result;
            }
            priceRanges.push(priceRange);
        }
        //检测价格区间
        var start1 = Number(priceRanges[0].startQuantity);
        var price1 = Number(priceRanges[0].price);
        var start2 = Number(priceRanges[1].startQuantity);
        var price2 = Number(priceRanges[1].price);
        var start3 = Number(priceRanges[2].startQuantity);
        var price3 = Number(priceRanges[2].price);
        result.success = start1 > start2 ? price1 < price2 : price1 > price2;
        result.success = start1 > start3 ? price1 < price3 : price1 > price3;
        result.success = start2 > start3 ? price2 < price3 : price2 > price3;
        if (result.success == false) {
            result.message = "价格区间信息错误";
        }
        result.data = priceRanges;
        return result;
    }
    //封装规格报价对象
    function getSpecPrices(specPriceDom) {
        var result = {
            success: true,
            message: "",
            data: {}
        };
        var specPriceDoms = specPriceDom.find("tr[class='specPrice']");
        var specPriceDomsShow = specPriceDom.find("tr[class='specPrice']:visible");
        var showPrice = $(specPriceDomsShow[0]).find("input[name='price']").val();
        if ($.trim(showPrice) == "" || showPrice == null || Number(showPrice) <= 0) {
            result.success = false;
            result.message = "产品阿里单价必填并且不能小于0";
            return result;
        }
        var showRetailprice = $(specPriceDomsShow[0]).find("input[name='retailprice']").val();
        if ($.trim(showRetailprice) == "" || showRetailprice == null || Number(showRetailprice) <= 0) {
            result.success = false;
            result.message = "产品建议零售价必填并且不能小于0";
            return result;
        }
        var specPrices = [];
        for (var i = 0; i < specPriceDoms.length; i++) {
            var specPrice = {};
            specPrice.skucode = $(specPriceDoms[i]).find("input[name='skucode']").val();
            specPrice.price = showPrice;
            specPrice.retailprice = showRetailprice;
            specPrices.push(specPrice);
        }
        result.data = specPrices;
        return result;
    }
    //设置一个变量存储进度条的进度信息
    var jinduTemp = 0;
    //进度条的显示方法
    function jindutiao(type, message, jinduNum) {
        var result = {};
        if (type == 1) {
            //发布中的进度条开始展示
            var jinduHtml = "<div class='progress progress-striped active'>" +
                "<div class='progress-bar  progress-bar-info' role='progressbar' aria-valuenow='60' aria-valuemin='0' aria-valuemax='100' style='width: " + jinduNum + "%;'>" +
                "</div></div>";
            $("#aliStoreModal").find("div.modal-footer").hide();
            $("#aliStoreModal").find("div.modal-header").find("button.close").hide();
            $("#aliStoreModal").find("h4.modal-title").html("发布中");
            $("#aliStoreModal").find("div.modal-body").html(jinduHtml);
            var timeInterval1 = window.setInterval(function () {
                if (jinduNum < 95) {
                    jinduNum++;
                }
                var widthTemp = jinduNum + '%';
                $("#aliStoreModal").find("div.modal-body").find("div.progress-bar").css("width", widthTemp);
                return timeIntervalCallback(jinduNum);
            }, 1000);
            return timeInterval1;
        } else if (type == 2) {
            //发布完成后进度条开始加速展示
            var jinduHtml = "<div class='progress progress-striped active'>" +
                "<div class='progress-bar  progress-bar-info' role='progressbar' aria-valuenow='60' aria-valuemin='0' aria-valuemax='100' style='width: " + jinduNum + "%;'>" +
                "</div></div>";
            $("#aliStoreModal").find("div.modal-footer").hide();
            $("#aliStoreModal").find("div.modal-header").find("button.close").hide();
            $("#aliStoreModal").find("h4.modal-title").html("发布中");
            $("#aliStoreModal").find("div.modal-body").html(jinduHtml);
            var timeInterval2 = window.setInterval(function () {
                jinduNum++;
                var widthTemp = jinduNum + '%';
                $("#aliStoreModal").find("div.modal-body").find("div.progress-bar").css("width", widthTemp);
                if (jinduNum >= 110) {
                    window.clearInterval(timeInterval2);
                    $("#aliStoreModal").find("div.modal-footer").show();
                    $("#aliStoreModal").find("h4.modal-title").html("提示");
                    $("#aliStoreModal").find("div.modal-body").html(message);
                    $("#aliStoreModal").modal("show");
                }
                ;
                return timeIntervalCallback(jinduNum);
            }, 100);
            return timeInterval2;
        }
    }
    //进度条定时器回调方法，给全局变量中的进度条变量赋值
    function timeIntervalCallback(jinduNum) {
        jinduTemp = jinduNum;
    }
    //入口函数
    $(function () {
        //获取下载数据包的提交按钮
        var submit0 = $("#aliModal").find("button[name='submit0']");
        //获取一键铺货的提交按钮
        var submit1 = $("#aliModal").find("button[name='submit1']");
        var memberId = memberId;
        var productId;
        //店铺下拉框
        var selectChoose = $("#productToAliForm").find("select[name='storeidforproduct']");
        //一口价的table
        var specPricesDom = $("#productToAliForm").find("div.specPricesBySkuClass");
        //阶梯价的table
        var priceRangeDom = $("#productToAliForm").find("div.priceRangesBySkuNum");
        //点击下载数据包
        /*$(".producttoalidowndata").click(function () {
         //通过按钮绑定的productid给全局变量productId赋值
         productId = $(this).data("productid");
         findStore2(memberId, selectChoose);
         submit1.hide();
         submit0.show();
         });*/
        //点击一键铺货弹出弹框,渲染店铺列表和商品sku信息
        $(".producttoali").click(function () {
            var loginType = isUserLogin();
            if(!loginType){
                alitongLogin();
            }
            //通过按钮绑定的productid给全局变量productId赋值
            productId = $(this).data("productid");
            findStore(productId, specPricesDom, priceRangeDom, memberId, selectChoose);
            submit0.hide();
            submit1.show();
            if ($("#productToAliForm").find("select[name='quoteType']").val() == 1) {
                //按照sku规格（一口价）
                $("#productToAliForm").find("div.priceRangesBySkuNum").hide();
                $("#productToAliForm").find("div.specPricesBySkuClass").show();
            } else if ($("#productToAliForm").find("select[name='quoteType']").val() == 2) {
                //按照sku数量（阶梯价）
                $("#productToAliForm").find("div.specPricesBySkuClass").hide();
                $("#productToAliForm").find("div.priceRangesBySkuNum").show();
            }
            //报价方式的div
            $("#productToAliForm").find("div.quoteDiv").show();
        });
        //绑定下载数据包的提交方法
        /*submit0.click(function () {
         //阿里商铺id
         var storeidforproduct = $("#productToAliForm").find("select[name='storeidforproduct']").val();
         $.ajax({
         async: false,
         type: "POST",
         url: "/product/productToAli",
         data: {"dataType": 0, "productId": productId, "storeId": storeidforproduct},
         success: function (msg) {
         $("#aliStoreModal").find("h4.modal-title").html("提示");
         $("#aliStoreModal").find("div.modal-body").html(msg.message);
         $("#productToAliForm")[0].reset();
         $("#aliModal").modal("hide");
         $("#aliStoreModal").modal("show");
         }
         });
         });*/
        //绑定上传至阿里的提交方法
        submit1.click(function () {
            //阿里商铺id
            var storeidforproduct = $("#productToAliForm").find("select[name='storeidforproduct']").val();
            //报价方式
            var quoteType = $("#productToAliForm").find("select[name='quoteType']").val();
            if (quoteType == 1) {
                //按规格报价，封装一口价信息
                var specPriceDom = $("#productToAliForm").find("div.specPricesBySkuClass");
                var result = getSpecPrices(specPriceDom);
                if (result.success) {
                    var specPrices = result.data;
                } else {
                    alert(result.message);
                    return;
                }
                var aliResult = {
                    "specPrices": specPrices,
                    "quoteType": quoteType,
                    "storeId": storeidforproduct
                };
                $.ajax({
                    type: "POST",
                    url: "/product/productToAli",
                    data: {"dataType": 1, "productId": productId, "aliResult": JSON.stringify(aliResult)},
                    success: function (msg) {
                        window.clearInterval(timeinterval1);
                        //打印铺货请求的失败或成功信息到控制台
                        console.log(msg.data);
                        console.log(msg.backUrl);
                        if (msg.success) {
                            jindutiao(2, msg.message, jinduTemp);
                        } else {
                            $("#aliStoreModal").find("div.modal-footer").show();
                            $("#aliStoreModal").find("h4.modal-title").html("提示");
                            $("#aliStoreModal").find("div.modal-body").html(msg.message);
                            $("#aliStoreModal").modal("show");
                        }
                    }
                });
            } else if (quoteType == 2) {
                //按数量报价，检测建议零售价
                var retailprice = $("#productToAliForm").find("input[name='retailprice']").val();
                if ($.trim(retailprice) == "" || retailprice == null || Number(retailprice) <= 0) {
                    alert("建议零售价必填并且不能小于0");
                    return;
                }
                //封装阶梯价信息
                var priceRangeDom = $("#productToAliForm").find("div.priceRangesBySkuNum");
                var result = getPriceRanges(priceRangeDom);
                if (result.success) {
                    var priceRanges = result.data;
                } else {
                    alert(result.message);
                    return;
                }
                var aliResult = {
                    "retailprice": retailprice,
                    "quoteType": quoteType,
                    "storeId": storeidforproduct,
                    "priceRanges": priceRanges
                };
                $.ajax({
                    type: "POST",
                    url: "/product/productToAli",
                    data: {"dataType": 1, "productId": productId, "aliResult": JSON.stringify(aliResult)},
                    success: function (msg) {
                        window.clearInterval(timeinterval1);
                        //打印铺货请求的失败或成功信息到控制台
                        console.log(msg.data);
                        console.log(msg.backUrl);
                        if (msg.success) {
                            jindutiao(2, msg.message, jinduTemp);
                        } else {
                            $("#aliStoreModal").find("div.modal-footer").show();
                            $("#aliStoreModal").find("h4.modal-title").html("提示");
                            $("#aliStoreModal").find("div.modal-body").html(msg.message);
                            $("#aliStoreModal").modal("show");
                        }
                    }
                });
            }
            //点击发送了ajax请求，进度条开始计算
            var timeinterval1 = jindutiao(1, "", 0);
            //对表单进行初始化操作并隐藏modal
            $("#productToAliForm")[0].reset();
            $("#aliModal").modal("hide");
            //进度条取消用户手动取消权限
            $('#aliStoreModal').modal({backdrop: 'static', keyboard: false});
        });
        //选择不同的价格设置方式绑定change方法
        /*$("#productToAliForm").find("select[name='quoteType']").change(function () {
         if ($(this).val() == 1) {
         //按照sku规格
         $("#productToAliForm").find("div.priceRangesBySkuNum").hide();
         $("#productToAliForm").find("div.specPricesBySkuClass").show();
         } else if ($(this).val() == 2) {
         //按照sku数量
         $("#productToAliForm").find("div.specPricesBySkuClass").hide();
         $("#productToAliForm").find("div.priceRangesBySkuNum").show();
         }
         });*/
    });
    //阿里通授权流程
    function shouquanProtocol(){
        modals.alitong_protocol.showmodal();
        modals.alitong_protocol.cover.find(".big").click(function(){
            if($(this).attr('class').indexOf('disable')== -1){
                modals.alitong_protocol.hidemodal();
                //打开对接弹窗
                modals.alitong_apply.protocolType = "yijianpuhuo";
                modals.alitong_apply.showmodal();
                modals.alitong_apply.cover.find(".sure").click(function(){
                    if (modals.alitong_apply.cansend()) {
                        //数据通过校验，转换数据格式进行ajax请求
                        var memberStore = JSON.stringify(modals.alitong_apply.getresult());
                        var newWin = window.open("http://www.dawawang.com");
                        $.ajax({
                            async: true,
                            type: "POST",
                            url: "/product/memberstoreadd",
                            data: {"memberStore": memberStore},
                            success: function (result) {
                                //请求成功，跳转至阿里的铺货授权页面
                                if (result.data) {
                                    newWin.location.href = "http://www.dawawang.com/services/alibaba_product.html";
                                }
                                //打开对接弹窗
                                modals.alitong_apply.hidemodal();
                                modals.alitong_apply.protocolType = "yijiandaifa";
                                modals.alitong_apply.showmodal();
                                modals.alitong_apply.cover.find(".sure").click(function(){
                                    if (modals.alitong_apply.cansend()) {
                                        //数据通过校验，转换数据格式进行ajax请求
                                        var memberStore = JSON.stringify(modals.alitong_apply.getresult());
                                        $.ajax({
                                            async: true,
                                            type: "POST",
                                            url: "/product/memberstoreadd",
                                            data: {"memberStore": memberStore},
                                            success: function (result) {
                                                //请求成功，跳转至阿里的铺货授权页面
                                                if (result.data) {
                                                    newWin.location.href = "http://www.dawawang.com/services/alibaba.html";
                                                }
                                            }
                                        });
                                    }
                                });

                            }
                        });
                    }
                });
            }
        });
    }
    //获取手机短信验证码
    function getmobVerify(this_){
        var obj = $(this_);
        var userName = modals.alitong_register.cover.find("div[data-name='username']").find("input");
        var verifyCode = modals.alitong_register.cover.find("div[data-name='verifyCode']").find("input");
        var textBool = obj.text().indexOf("获取验证码")>=0;
        var mob = userName.val();
        var verifycode = verifyCode.val();
        if(userName && verifyCode && textBool){
            $.ajax({
                type : 'get',
                url : domain + '/sendVerifySMS.html?mob=' + mob
                + '&verifycode=' + verifycode,
                success : function(e) {
                    if (e.success) {
                        var time = 120;
                        obj.text(time + "秒");
                        time--;
                        obj.data('msgCode',e.data);
                        intervalId = setInterval(function() {
                            obj.text(time + "秒");
                            if (time == 0) {
                                clearInterval(intervalId);
                                obj.text("获取验证码");
                            }
                            time--;
                        }, 1000);
                    } else {
                        alert(e.message);
                    }
                }
            });
        }
    }
    //验证验证码和手机验证码
    function checkRegisterParam(params,msgcode){
        var smsCode = params.smsCode;
        if(msgcode != smsCode){
            alert("手机验证码错误");
            return false;
        }
        var password = params.password;
        var repassword = params.repassword;
        if (repassword != password) {
            alert("两次输入密码不一致");
            return false;
        }
        modals.alitong_register.cover.find(".big").attr("disabled","disabled");
        return true;
    }
    //注册函数
    function register (params){
        params.name = params.username;
        params.lastLoginIp=domain.substring(domain.lastIndexOf('/')+1);
        params.memberType = 2;
        var resultB;
        $.ajax({
            type:"POST",
            url:domain + "/doregister.html",
            dataType:"json",
            async : false,
            data : params,
            success:function(data){
                resultB = data;
            },
            error:function(){
                alert("服务异常，请稍后重试！");
                resultB = false;
                //$("#registerBtn").removeAttr("disabled");
            }
        });
        return resultB;
    };
    //用户未登录流程
    function alitongLogin(){
        //弹出登录框
        modals.alitong_login.showmodal();
        //请求验证码
        modals.alitong_login.cover.find("div.fullinput:last span img").attr("src",domain+"/verify.html");
        //刷新验证码
        modals.alitong_login.cover.find("div.fullinput:last span img").click(function(){
            $(this).attr("src",domain+"/verify.html?d"+new Date().getTime());
        });
        //点击免费注册（此时进行商城，阿里通一并注册流程）
        modals.alitong_login.cover.find(".login_tag a:last-child").click(function(event){
            event.preventDefault();
            //关闭登录弹窗
            modals.alitong_login.hidemodal();
            //打开注册商城用户弹窗
            modals.alitong_register.showmodal();
            //请求验证码
            modals.alitong_register.cover.find("div.fullinput:last").prev().find("span img").attr("src",domain+"/verify.html?d"+new Date().getTime());
            //刷新验证码
            modals.alitong_register.cover.find("div.fullinput:last").prev().find("span img").click(function(){
                $(this).attr("src",domain+"/verify.html?d"+new Date().getTime());
            });
            //点击获取手机验证码事件
            modals.alitong_register.cover.find("span.getcode").click(function(){
                getmobVerify(this);
            });
            modals.alitong_register.cover.find(".big").click(function(){
                if($(this).attr('class').indexOf('disable')== -1){
                    //进行注册操作
                    if(modals.alitong_register.cansend()){
                        //收集注册信息进行初步验证
                        var b = checkRegisterParam(modals.alitong_register.getresult(),modals.alitong_register.cover.find("span.getcode").data('msgCode'));
                        if(b){
                            //信息正确进行注册
                            var resB = register(modals.alitong_register.getresult());
                            if(resB.success){
                                //注册成功进入授权流程,注册modal隐藏
                                modals.alitong_register.hidemodal();
                                //进入阿里通授权流程
                                shouquanProtocol();
                            };
                        }
                    }
                }
            });
        });
        //点击登录进入登录验证流程
        modals.alitong_login.cover.find(".big").click(function(event){
            //登录弹出框点击登录按钮
            if(modals.alitong_login.cansend()) {
                $(".big").attr("disabled", "disabled");
                var params = "";
                params += "name=" + modals.alitong_login.getresult().username;
                params += "&password=" + modals.alitong_login.getresult().password;
                params += "&verifyCode=" + modals.alitong_login.getresult().verifyCode;
                //用户登录
                $.ajax({
                    type: "POST",
                    url: domain + "/dodialoglogin.html",
                    dataType: "json",
                    async: false,
                    data: params,
                    success: function (data) {
                        if (data.success) {
                            //刷新session
                            location.reload();
                            //关闭登录弹窗
                            modals.alitong_login.hidemodal();
                            //此时用户已登录判断用户是否有授权店铺
                            $.ajax({
                                async: false,
                                type: "POST",
                                url: "/product/memberstores",
                                data: {"memberId": memberId},
                                success: function (result) {
                                    modals.alitong_login.hidemodal();
                                    if(result.message == "4"){
                                        //弹出商派阿里通授权协议（此时进行阿里通授权流程）
                                        modals.alitong_protocol.showmodal();
                                        shouquanProtocol();
                                    }else if(result.message == "6"){
                                        //弹出警示信息，关闭弹窗时刷新当前页面
                                        $("#aliStoreModal").find("h4.modal-title").html("系统提示");
                                        $("#aliStoreModal").find("div.modal-body").html("店铺请求提点信息失败，请去oms设置提点信息。");
                                        $('#aliStoreModal').modal('show');
                                        $('#aliStoreModal').on('hide.bs.modal', function () {
                                            window.location.reload();
                                        });
                                    }else if(result.message == "5"){
                                        successAliModal(result,productId,specPricesDom,priceRangeDom,selectChoose);
                                    }
                                }
                            })
                        } else {
                            var mess = new modal([
                                {name: "title", type: "title", content: "提示信息"},
                                {name: "xx23h", type: "note", content: data.message},
                                {
                                    name: "col融入i",
                                    type: "option",
                                    sub: "sure",
                                    link1: '22222',
                                    link2: '23231',
                                    text: '确定'
                                }
                            ]);
                            mess.showmodal();
                            //$(".sure").click(mess.hidemodal());
                            $(".sure").on('click', function () {
                                mess.hidemodal();
                            });
                            $("div.fullinput:last span img").attr("src", domain + "/verify.html?d" + new Date().getTime());
                            $(".big").removeAttr("disabled", "disabled");
                        }
                    },
                    error: function () {
                        var errorMess = new modal([
                            {name: "title", type: "title", content: "异常提示"},
                            {name: "xx23h", type: "note", content: "异常,请重试!"},
                            {
                                name: "col融入i",
                                type: "option",
                                sub: "sure",
                                link1: '22222',
                                link2: '23231',
                                text: '确定'
                            }
                        ]);
                        errorMess.showmodal();
                        $(".sure").on('click', function () {
                            mess.hidemodal();
                            $(".big").removeAttr("disabled", "disabled");
                        });
                    }
                });
            }
        });
    }
});